<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PPTX è¡¨è¨˜ã‚†ã‚Œå‰Šé™¤ãƒ»ç½®æ›</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .st-card { background: white; border-radius: 0.75rem; border: 1px solid #e5e7eb; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .main-container { max-width: 800px; margin: 2rem auto; padding: 0 1rem; }
        .upload-zone { border: 2px dashed #d1d5db; border-radius: 1rem; transition: all 0.2s; background: #fff; }
        .upload-zone:hover { border-color: #3b82f6; background-color: #f0f7ff; }
        .upload-zone.dragover { border-color: #3b82f6; background-color: #f0f7ff; }
        .mode-btn { transition: all 0.2s; border-width: 2px; }
        .mode-btn.active { background-color: #3b82f6; color: white; border-color: #3b82f6; }
        .security-badge { background-color: #ecfdf5; border: 1px solid #10b981; color: #065f46; }
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .word-row { animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div class="main-container">
        <!-- Header & Security Notice -->
        <header class="mb-10 text-center">
            <h1 class="text-4xl font-extrabold text-gray-900 mb-4">ğŸ“„ PPTX è¡¨è¨˜ã‚†ã‚Œå‰Šé™¤ãƒ»ç½®æ›</h1>
            <div class="inline-flex items-center gap-2 px-5 py-2 rounded-full security-badge text-sm font-bold mb-4">
                <svg class="w-5 h-5 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M2.166 4.999A11.954 11.954 0 0010 1.944 11.954 11.954 0 0017.834 5c.11.65.166 1.32.166 2.001 0 4.946-3.07 9.173-7.41 10.827a1.001 1.001 0 01-.76 0C5.47 16.173 2.4 11.946 2.4 7c0-.68.056-1.35.166-2.001zm8.847 3.012a1 1 0 10-1.414-1.414L8 8.172 6.707 6.879a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l3-3z" clip-rule="evenodd"></path>
                </svg>
                å®Œå…¨ãƒ­ãƒ¼ã‚«ãƒ«å®Ÿè¡Œï¼šãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ä¿è­·æ¸ˆã¿
            </div>
            <p class="text-gray-600 max-w-lg mx-auto leading-relaxed">ã™ã¹ã¦ã®å‡¦ç†ã¯ãƒ–ãƒ©ã‚¦ã‚¶å†…ã§å®Œçµã—ã¾ã™ã€‚ãƒ•ã‚¡ã‚¤ãƒ«ã¯å¤–éƒ¨é€ä¿¡ã•ã‚Œãšã€ã‚ãªãŸã®PCå†…ã ã‘ã§å®‰å…¨ã«å‡¦ç†ã•ã‚Œã¾ã™ã€‚</p>
        </header>

        <section class="space-y-6">
            <div class="st-card p-10">
                <!-- Mode Selector -->
                <div class="mb-8 flex flex-col gap-3">
                    <label class="text-xs font-black text-gray-400 uppercase tracking-widest">STEP 1: ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’é¸æŠ</label>
                    <div class="flex gap-4">
                        <button id="mode-delete" class="mode-btn active flex-1 py-4 px-4 rounded-xl font-bold shadow-sm">å‰Šé™¤</button>
                        <button id="mode-replace" class="mode-btn flex-1 py-4 px-4 rounded-xl font-bold text-gray-600 border-gray-200 shadow-sm">ç½®æ›</button>
                    </div>
                </div>

                <!-- File Upload -->
                <div class="mb-8">
                    <label class="text-xs font-black text-gray-400 uppercase tracking-widest block mb-3">STEP 2: ãƒ‘ãƒ¯ãƒ¼ãƒã‚¤ãƒ³ãƒˆã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</label>
                    <div id="drop-zone" class="upload-zone p-12 flex flex-col items-center justify-center cursor-pointer">
                        <div class="bg-blue-50 p-5 rounded-2xl mb-4">
                            <svg class="w-12 h-12 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
                            </svg>
                        </div>
                        <p class="text-gray-700 font-semibold" id="file-name-display">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ (.pptx)</p>
                        <input type="file" id="file-input" class="hidden" accept=".pptx">
                    </div>
                </div>

                <!-- Inputs Area -->
                <div class="mb-10">
                    <label class="text-xs font-black text-gray-400 uppercase tracking-widest block mb-3">STEP 3: æ–‡è¨€ã®æŒ‡å®š</label>
                    
                    <!-- Word rows container -->
                    <div id="word-rows-container" class="space-y-3">
                        <!-- æœ€åˆã®è¡Œ -->
                        <div class="word-row flex gap-3 items-center" data-row-id="1">
                            <div class="flex-1">
                                <input type="text" class="target-text w-full p-4 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none" placeholder="æ¤œç´¢ã™ã‚‹æ–‡è¨€ï¼ˆä¾‹: å¼•è¶Šã—ï¼‰">
                            </div>
                            <div class="flex-1 replacement-field hidden">
                                <input type="text" class="replacement-text w-full p-4 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none" placeholder="ç½®æ›å¾Œï¼ˆä¾‹: å¼•è¶Šï¼‰">
                            </div>
                            <button class="remove-row-btn hidden w-12 h-12 bg-red-100 hover:bg-red-200 text-red-600 rounded-xl font-bold text-xl transition-all flex items-center justify-center">
                                âˆ’
                            </button>
                        </div>
                    </div>

                    <!-- Add button -->
                    <button id="add-row-btn" class="mt-4 w-full py-3 border-2 border-dashed border-gray-300 hover:border-blue-500 hover:bg-blue-50 text-gray-500 hover:text-blue-600 rounded-xl font-bold transition-all flex items-center justify-center gap-2">
                        <span class="text-2xl">+</span>
                        <span>æ–‡è¨€ã‚’è¿½åŠ </span>
                    </button>
                </div>

                <!-- Action Button -->
                <button id="run-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-extrabold py-5 px-6 rounded-2xl shadow-xl transition-all flex items-center justify-center gap-3">
                    <span id="btn-text" class="text-xl text-white">å‰Šé™¤ã‚’å®Ÿè¡Œã™ã‚‹</span>
                </button>
            </div>

            <!-- Results area -->
            <div id="result-area" class="hidden space-y-4">
                <div id="status-box" class="p-5 rounded-2xl flex items-center gap-4 bg-white border border-blue-100 text-blue-700 shadow-sm">
                    <div id="status-icon"><div class="loading-spinner"></div></div>
                    <span id="status-text" class="font-bold">å‡¦ç†ä¸­...</span>
                </div>
                
                <div id="download-box" class="hidden">
                    <div class="bg-white border-4 border-green-500 p-10 rounded-3xl text-center shadow-2xl">
                        <h3 class="text-2xl font-black text-gray-900 mb-4">å®Œäº†ã—ã¾ã—ãŸï¼</h3>
                        <div id="success-msg" class="text-gray-600 mb-8 font-medium"></div>
                        <button id="download-btn" class="bg-green-600 hover:bg-green-700 text-white px-12 py-4 rounded-2xl font-black text-lg transition-all transform hover:scale-105">
                            ä¿®æ­£æ¸ˆã¿ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜
                        </button>
                    </div>
                </div>

                <!-- Error Box -->
                <div id="error-box" class="hidden">
                    <div class="bg-white border-4 border-red-500 p-10 rounded-3xl text-center shadow-2xl">
                        <h3 class="text-2xl font-black text-red-600 mb-4">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</h3>
                        <p id="error-msg" class="text-gray-600 mb-4 font-medium"></p>
                    </div>
                </div>
            </div>
        </section>

        <footer class="mt-16 text-center text-gray-400 text-xs pb-10">
            <p>ğŸ”’ Security: No cloud, No external API, 100% Local Processing.</p>
        </footer>
    </div>

    <script>
        let currentMode = 'delete';
        let processedBlob = null;
        let originalFileName = '';
        let rowIdCounter = 1;

        const modeReplace = document.getElementById('mode-replace');
        const modeDelete = document.getElementById('mode-delete');
        const btnText = document.getElementById('btn-text');
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const fileNameDisplay = document.getElementById('file-name-display');
        const runBtn = document.getElementById('run-btn');
        const resultArea = document.getElementById('result-area');
        const statusBox = document.getElementById('status-box');
        const statusText = document.getElementById('status-text');
        const statusIcon = document.getElementById('status-icon');
        const downloadBox = document.getElementById('download-box');
        const downloadBtn = document.getElementById('download-btn');
        const successMsg = document.getElementById('success-msg');
        const errorBox = document.getElementById('error-box');
        const errorMsg = document.getElementById('error-msg');
        const wordRowsContainer = document.getElementById('word-rows-container');
        const addRowBtn = document.getElementById('add-row-btn');

        // Update remove buttons visibility
        function updateRemoveButtons() {
            const rows = wordRowsContainer.querySelectorAll('.word-row');
            rows.forEach(row => {
                const removeBtn = row.querySelector('.remove-row-btn');
                if (rows.length > 1) {
                    removeBtn.classList.remove('hidden');
                } else {
                    removeBtn.classList.add('hidden');
                }
            });
        }

        // Add new row
        function addRow() {
            rowIdCounter++;
            const newRow = document.createElement('div');
            newRow.className = 'word-row flex gap-3 items-center';
            newRow.dataset.rowId = rowIdCounter;
            
            const replacementHiddenClass = currentMode === 'delete' ? 'hidden' : '';
            
            newRow.innerHTML = `
                <div class="flex-1">
                    <input type="text" class="target-text w-full p-4 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none" placeholder="æ¤œç´¢ã™ã‚‹æ–‡è¨€ï¼ˆä¾‹: å¼•è¶Šã—ï¼‰">
                </div>
                <div class="flex-1 replacement-field ${replacementHiddenClass}">
                    <input type="text" class="replacement-text w-full p-4 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none" placeholder="ç½®æ›å¾Œï¼ˆä¾‹: å¼•è¶Šï¼‰">
                </div>
                <button class="remove-row-btn w-12 h-12 bg-red-100 hover:bg-red-200 text-red-600 rounded-xl font-bold text-xl transition-all flex items-center justify-center">
                    âˆ’
                </button>
            `;
            
            wordRowsContainer.appendChild(newRow);
            
            // Add remove event
            newRow.querySelector('.remove-row-btn').addEventListener('click', () => {
                newRow.remove();
                updateRemoveButtons();
            });
            
            updateRemoveButtons();
        }

        // Add row button click
        addRowBtn.addEventListener('click', addRow);

        // Initial remove button event
        document.querySelector('.remove-row-btn').addEventListener('click', function() {
            if (wordRowsContainer.querySelectorAll('.word-row').length > 1) {
                this.closest('.word-row').remove();
                updateRemoveButtons();
            }
        });

        // Mode Switching
        modeReplace.onclick = () => {
            currentMode = 'replace';
            modeReplace.classList.add('active');
            modeDelete.classList.remove('active');
            // Show all replacement fields
            document.querySelectorAll('.replacement-field').forEach(el => el.classList.remove('hidden'));
            btnText.innerText = "ç½®æ›ã‚’å®Ÿè¡Œã™ã‚‹";
        };

        modeDelete.onclick = () => {
            currentMode = 'delete';
            modeDelete.classList.add('active');
            modeReplace.classList.remove('active');
            // Hide all replacement fields
            document.querySelectorAll('.replacement-field').forEach(el => el.classList.add('hidden'));
            btnText.innerText = "å‰Šé™¤ã‚’å®Ÿè¡Œã™ã‚‹";
        };

        // File Upload
        dropZone.onclick = () => fileInput.click();
        
        fileInput.onchange = (e) => {
            if (e.target.files.length > 0) {
                originalFileName = e.target.files[0].name;
                fileNameDisplay.innerText = originalFileName;
                fileNameDisplay.classList.add('text-blue-600');
            }
        };

        // Drag & Drop
        dropZone.ondragover = (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        };
        
        dropZone.ondragleave = (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
        };
        
        dropZone.ondrop = (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            if (e.dataTransfer.files.length > 0) {
                const file = e.dataTransfer.files[0];
                if (file.name.endsWith('.pptx')) {
                    fileInput.files = e.dataTransfer.files;
                    originalFileName = file.name;
                    fileNameDisplay.innerText = originalFileName;
                    fileNameDisplay.classList.add('text-blue-600');
                } else {
                    alert('.pptxãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿å¯¾å¿œã—ã¦ã„ã¾ã™');
                }
            }
        };

        // Download button
        downloadBtn.onclick = () => {
            if (processedBlob) {
                const newFileName = originalFileName.replace('.pptx', '_ä¿®æ­£æ¸ˆ.pptx');
                saveAs(processedBlob, newFileName);
            }
        };

        // Get all word pairs
        function getWordPairs() {
            const pairs = [];
            const rows = wordRowsContainer.querySelectorAll('.word-row');
            rows.forEach(row => {
                const target = row.querySelector('.target-text').value.trim();
                const replacement = row.querySelector('.replacement-text').value.trim();
                if (target) {
                    pairs.push({ target, replacement });
                }
            });
            return pairs;
        }

        // Process PPTX
        async function processPptx(file, wordPairs, mode) {
            const zip = await JSZip.loadAsync(file);
            const results = {};
            let totalCount = 0;

            // Initialize results
            wordPairs.forEach(pair => {
                results[pair.target] = 0;
            });

            // Process all XML files in the PPTX
            const xmlFiles = Object.keys(zip.files).filter(name => 
                name.endsWith('.xml') || name.endsWith('.rels')
            );

            for (const fileName of xmlFiles) {
                let content = await zip.file(fileName).async('string');
                
                // Process each word pair
                for (const pair of wordPairs) {
                    const regex = new RegExp(escapeRegExp(pair.target), 'g');
                    const matches = content.match(regex);
                    
                    if (matches) {
                        results[pair.target] += matches.length;
                        totalCount += matches.length;
                        content = mode === 'delete' 
                            ? content.replace(regex, '')
                            : content.replace(regex, pair.replacement);
                    }
                }
                
                zip.file(fileName, content);
            }

            const blob = await zip.generateAsync({ type: 'blob', mimeType: 'application/vnd.openxmlformats-officedocument.presentationml.presentation' });
            return { blob, results, totalCount };
        }

        // Escape special characters for regex
        function escapeRegExp(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        // Run button click handler
        runBtn.onclick = async () => {
            const wordPairs = getWordPairs();

            if (wordPairs.length === 0) {
                return alert("æ¤œç´¢ã™ã‚‹æ–‡è¨€ã‚’1ã¤ä»¥ä¸Šå…¥åŠ›ã—ã¦ãã ã•ã„");
            }

            if (!fileInput.files || fileInput.files.length === 0) {
                return alert("PPTXãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„");
            }

            // Reset state
            runBtn.disabled = true;
            runBtn.classList.add('opacity-50');
            resultArea.classList.remove('hidden');
            downloadBox.classList.add('hidden');
            errorBox.classList.add('hidden');
            statusBox.className = "p-5 rounded-2xl flex items-center gap-4 bg-white border border-blue-100 text-blue-700 shadow-sm";
            statusIcon.innerHTML = '<div class="loading-spinner"></div>';
            statusText.innerText = "ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‡¦ç†ä¸­...";

            try {
                const file = fileInput.files[0];
                const result = await processPptx(file, wordPairs, currentMode);
                
                processedBlob = result.blob;

                // Success
                statusBox.className = "p-5 rounded-2xl flex items-center gap-4 bg-green-50 text-green-700 border border-green-200";
                statusText.innerText = "æˆåŠŸï¼šå…¨ã‚¹ãƒ©ã‚¤ãƒ‰ã®å‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸ";
                statusIcon.innerHTML = 'âœ…';

                // Build result message
                const actionText = currentMode === 'replace' ? 'ç½®æ›' : 'å‰Šé™¤';
                let resultHtml = `<p class="mb-2">åˆè¨ˆ <strong>${result.totalCount}ç®‡æ‰€</strong> ã‚’${actionText}ã—ã¾ã—ãŸã€‚</p>`;
                resultHtml += '<ul class="text-left inline-block">';
                for (const pair of wordPairs) {
                    const count = result.results[pair.target];
                    if (currentMode === 'replace') {
                        resultHtml += `<li>ã€Œ${pair.target}ã€â†’ã€Œ${pair.replacement}ã€: ${count}ç®‡æ‰€</li>`;
                    } else {
                        resultHtml += `<li>ã€Œ${pair.target}ã€: ${count}ç®‡æ‰€</li>`;
                    }
                }
                resultHtml += '</ul>';
                successMsg.innerHTML = resultHtml;
                downloadBox.classList.remove('hidden');

            } catch (error) {
                statusBox.className = "p-5 rounded-2xl flex items-center gap-4 bg-red-50 text-red-700 border border-red-200";
                statusText.innerText = "ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ";
                statusIcon.innerHTML = 'âŒ';
                errorMsg.innerText = error.message;
                errorBox.classList.remove('hidden');
            } finally {
                runBtn.disabled = false;
                runBtn.classList.remove('opacity-50');
            }
        };
    </script>
</body>
</html>
